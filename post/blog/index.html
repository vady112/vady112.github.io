<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Managing our secrets with Vault. | Blog</title>

<meta property='og:title' content='Managing our secrets with Vault. - Blog'>
<meta property='og:description' content='We are using Ansible for intra-service orchestration and Hashicorp&rsquo;s Vault to Manage the the secrets. With ansible-modules-hashivault its easy to read the data from ansible by just using ansible lookup module. database_password: &quot;{{lookup(&#39;hashivault&#39;, &#39;production&#39;, &#39;database_passowrd&#39;)}}&quot;
How are we writing seccrets to Vault using Ansible?
We are using json file to upload the multiple secrets to the Vault. As we are pushing our Ansible playbooks to github we dint want to push plain text files to github, so we opted to encrypt the file using Ansible vault before pushing it to github.'>
<meta property='og:url' content='https://vady112.github.io/post/blog/'>
<meta property='og:site_name' content='Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/52bee659357a2ec7785965f345a4b4c0?s=256'><meta property='article:author' content='https://facebook.com/vardhaman.shetti'><meta property='article:section' content='Post'><meta property='article:published_time' content='2017-12-04T00:00:00Z'/><meta property='article:modified_time' content='2017-12-04T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@vady108'><meta name='twitter:creator' content='@vady108'>
<link rel="stylesheet" href="https://vady112.github.io//css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://vady112.github.io/"><h1 class="title is-4">Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:vardhaman@doselect.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://facebook.com/vardhaman.shetti' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/vady112' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/vardhaman-shetti-5862a8bb' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/vady108' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">December 4, 2017</h2>
    <h1 class="title">Managing our secrets with Vault.</h1>
      
    <div class="content">
      <p>We are using Ansible for intra-service orchestration and Hashicorp&rsquo;s <a href="https://www.vaultproject.io/" target="_blank">Vault</a>  to Manage the the secrets. With <a href="https://pypi.python.org/pypi/ansible-modules-hashivault" target="_blank">ansible-modules-hashivault</a> its easy to read the data from ansible by just using ansible lookup module.
<code>database_password: &quot;{{lookup('hashivault', 'production', 'database_passowrd')}}&quot;</code></p>

<p><strong>How are we writing seccrets to Vault using Ansible?</strong></p>

<p>We are using json file to upload the multiple secrets to the Vault. As we are pushing our Ansible playbooks to github we dint want to push plain text files to github, so we opted to encrypt the file using Ansible vault before pushing it to github.</p>

<p>Create file containing of secrets in the follwing format:</p>

<pre><code>vady@bat:~/playbooks/roles/vault/files$ cat production 

{ &quot;db_password&quot;:&quot;your_passowrd&quot;, &quot;application_password&quot; } 
</code></pre>

<p>Now, you can encrypt the existing file by typing:</p>

<p><code>ansible-vault encrypt production</code></p>

<p>You will be prompted to provide and confirm a password. Afterwards, a message will confirm the encryption.</p>

<p>When you need to add secrets in an encrypted file use:</p>

<p><code>ansible-vault edit  edit vault.yml</code></p>

<p>Now you we ready to write the secrets to the Vault.</p>

<p>We are first copying files to vault server, writing secrets using those files and deleting them after writing the secrets.</p>

<pre><code>- name: Copy secret file
  copy: src={{ item }} dest={{ vault_config_dir}}/{{ item }}.json
  with_items:
    - development
    - production
  
- name: Add secret variables to vault
  become: yes
  shell: cd {{ vault_config_dir}} &amp;&amp; vault write  -address=http://127.0.0.1:8200 secret/{{ item }} @{{ item }}.json
  with_items: 
     - development
     - production

- name: Make sure secrete files are deleted after adding secret
  file: path={{ vault_config_dir}}/{{ item }} state=absent

</code></pre>

<p>While running the playbook you need to pass the ansible-vault password, for example:</p>

<p><code>sudo ansible-playbook --private-key={{ path-to-private-key }} -i hosts vault.yml --ask-vault-pass</code></p>

<p>You will be prompted to a password.</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'vady';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/vady112">Emir Ribic</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>

</body>
</html>
